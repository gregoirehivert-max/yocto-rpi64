header:
  version: 14

machine: sl1640spi
distro: poky

target:
  - astra-tiny

repos:
  poky:
    url: "https://git.yoctoproject.org/git/poky"
    branch: scarthgap
    layers:
      meta:
      meta-poky:
      meta-yocto-bsp:

  meta-openembedded:
    url: "https://git.openembedded.org/meta-openembedded"
    branch: scarthgap
    layers:
      meta-oe:
      meta-python:
      meta-networking:
      meta-filesystems:

  meta-swupdate:
    url: "https://github.com/sbabic/meta-swupdate"
    branch: scarthgap

  meta-synaptics:
    url: "https://github.com/synaptics-astra/meta-synaptics"
    branch: scarthgap_6.12_v2.1.0

local_conf_header:
  optimizations: |
    # ============================================
    # OPTIMISATIONS ESPACE DISQUE (CRITIQUE CI/CD)
    # ============================================
    
    # Suppression automatique des work directories après build
    INHERIT += "rm_work"

    # Ne jamais nettoyer ces recettes natives
    RM_WORK_EXCLUDE += "pseudo-native opkg-utils-native qemu-native"

    # Ne pas générer de tarballs miroir (économise beaucoup d'espace)
    BB_GENERATE_MIRROR_TARBALLS = "0"
    
    # Générer des tarballs shallow (git history minimale)
    BB_GENERATE_SHALLOW_TARBALLS = "1"
    
    # Limite le nombre de tâches conservées en parallèle
    BB_NUMBER_PARSE_THREADS = "2"
    BB_NUMBER_THREADS = "2"
    PARALLEL_MAKE = "-j 2"
    
    # ============================================
    # CACHE ET TÉLÉCHARGEMENTS
    # ============================================
    
    # Répertoires de cache (peut être partagé entre builds)
    DL_DIR = "/work/downloads"
    SSTATE_DIR = "/work/sstate-cache"
    
    # Nettoyage automatique des anciens sstate (garde 30 jours max)
    SSTATE_PRUNE_MONTHS = "1"
    
    # ============================================
    # FORMAT IMAGE MINIMAL
    # ============================================
    # Désactiver synaspiimg qui échoue
    IMAGE_FSTYPES:remove = "synaspiimg"
    
    # ... reste de la config
    # Format image compact (tar.gz uniquement, pas de ext4 non compressé)
    IMAGE_FSTYPES = "tar.gz wic.gz"
    
    # Compression maximale
    IMAGE_ROOTFS_EXTRA_SPACE = "0"
    
    # ============================================
    # LICENCES SYNAPTICS
    # ============================================
    
    ACCEPT_SYNA_EULA = "1"
    LICENSE_FLAGS_ACCEPTED:append = " commercial"
    LICENSE_FLAGS_ACCEPTED:append = " synaptics-killswitch"
    LICENSE_FLAGS_ACCEPTED:append = " Synaptics-EULA"
    
    # ============================================
    # CONFIGURATION SYSTÈME
    # ============================================
    
    DISTRO_FEATURES:append = " systemd usrmerge"
    
    # Retirer X11, OpenGL, Wayland si non nécessaires
    DISTRO_FEATURES:remove = "x11 wayland opengl vulkan"

    DISTRO_FEATURES_BACKFILL_CONSIDERED += "sysvinit"
    VIRTUAL-RUNTIME_init_manager = "systemd"
    VIRTUAL-RUNTIME_initscripts = "systemd-compat-units"
    
    # ============================================
    # MACHINE ET DISTRIBUTION
    # ============================================
    
    MACHINE = "sl1640spi"
    PACKAGE_CLASSES = "package_ipk"
    CONF_VERSION = "2"
    
    # ============================================
    # MONITORING ESPACE DISQUE
    # ============================================
    
    # Arrête le build si moins de 1GB disponible
    BB_DISKMON_DIRS = "\
        STOPTASKS,${TMPDIR},1G,100K \
        STOPTASKS,${DL_DIR},1G,100K \
        STOPTASKS,${SSTATE_DIR},1G,100K \
        ABORT,${TMPDIR},500M,1K \
        ABORT,${DL_DIR},500M,1K \
        ABORT,${SSTATE_DIR},500M,1K"