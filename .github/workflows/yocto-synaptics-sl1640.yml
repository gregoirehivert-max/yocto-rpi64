name: Yocto Synaptics SL1640 Astra-Tiny Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'kas-sl1640.yml'
      - '.github/workflows/yocto-synaptics-sl1640.yml'
  workflow_dispatch:

jobs:
  build-sl1640:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        echo "Espace avant:"
        df -h
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android
        sudo rm -rf /opt/hostedtoolcache/CodeQL /usr/local/.ghcup
        sudo apt-get clean
        sudo docker image prune --all --force
        echo "Espace apr√®s:"
        df -h

    - name: Cache downloads
      uses: actions/cache@v4
      with:
        path: build-sl1640/downloads
        key: yocto-sl1640spi-tiny-dl-${{ hashFiles('kas-sl1640.yml') }}
        restore-keys: yocto-sl1640spi-tiny-dl-

    - name: Cache sstate
      uses: actions/cache@v4
      with:
        path: build-sl1640/sstate-cache
        key: yocto-sl1640spi-tiny-sstate-${{ hashFiles('kas-sl1640.yml') }}-${{ github.run_number }}
        restore-keys: |
          yocto-sl1640spi-tiny-sstate-${{ hashFiles('kas-sl1640.yml') }}-
          yocto-sl1640spi-tiny-sstate-

    - name: Build with Synaptics CROPS + Kas
      run: |
        docker run --rm \
          -v $(pwd):$(pwd) \
          -e KAS_BUILD_DIR=$(pwd)/build-sl1640 \
          -e MACHINE=sl1640spi \
          -e ACCEPT_SYNA_EULA=1 \
          ghcr.io/synaptics-astra/crops:1.1.0 \
          --workdir=$(pwd) \
          /bin/bash -c "
            wget -O kas-container https://raw.githubusercontent.com/siemens/kas/master/kas-container && \
            chmod +x kas-container && \
            ./kas-container shell kas-sl1640.yml -c 'bitbake astra-tiny'
          "

    - name: Show build stats
      run: |
        echo "Build size:"
        du -sh build-sl1640/ || true
        echo "Images:"
        find build-sl1640/tmp/deploy/images/sl1640spi/ -name "*astra-tiny*" -o -name "*.wic.bz2" || true
        df -h

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl1640spi-astra-tiny-${{ github.sha }}
        path: |
          build-sl1640/tmp/deploy/images/sl1640spi/SYNAIMG/*
          build-sl1640/tmp/deploy/images/sl1640spi/*astra-tiny*
        retention-days: 7