name: Yocto Synaptics SL1640 Astra-Tiny Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'kas-sl1640.yml'
      - '.github/workflows/yocto-synaptics-sl1640.yml'
  workflow_dispatch:

jobs:
  build-sl1640:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        echo "Espace avant:"
        df -h
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY" /usr/local/lib/android
        sudo rm -rf /opt/hostedtoolcache/CodeQL /usr/local/.ghcup
        sudo apt-get clean
        sudo docker image prune --all --force
        echo "Espace apr√®s:"
        df -h

    - name: Cache downloads
      uses: actions/cache@v4
      with:
        path: build-sl1640/downloads
        key: yocto-sl1640-dl-${{ hashFiles('kas-sl1640.yml') }}
        restore-keys: yocto-sl1640-dl-

    - name: Cache sstate
      uses: actions/cache@v4
      with:
        path: build-sl1640/sstate-cache
        key: yocto-sl1640-sstate-${{ hashFiles('kas-sl1640.yml') }}-${{ github.run_number }}
        restore-keys: |
          yocto-sl1640-sstate-${{ hashFiles('kas-sl1640.yml') }}-
          yocto-sl1640-sstate-

    - name: Download kas-container
      run: |
        wget -O kas-container https://raw.githubusercontent.com/siemens/kas/master/kas-container
        chmod +x kas-container

    - name: Build SL1640 astra-tiny
      run: |
        export KAS_BUILD_DIR=$(pwd)/build-sl1640
        ./kas-container build kas-sl1640.yml

    - name: Show build stats
      run: |
        echo "Build size:"
        du -sh build-sl1640/ || true
        echo "Artefacts:"
        find build-sl1640/tmp/deploy/images/sl1640spi/ -type f || true
        df -h

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl1640spi-astra-tiny-${{ github.sha }}
        path: |
          build-sl1640/tmp/deploy/images/sl1640spi/*.wic.bz2
          build-sl1640/tmp/deploy/images/sl1640spi/*.tar.bz2
          build-sl1640/tmp/deploy/images/sl1640spi/Image*
        retention-days: 7