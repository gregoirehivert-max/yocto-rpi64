name: Yocto Synaptics SL1640 Scarthgap v2.1.0

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'kas-sl1640.yml'
      - '.github/workflows/yocto-synaptics-sl1640.yml'
  workflow_dispatch:

jobs:
  build-sl1640-scarthgap:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # LIBÉRATION D'ESPACE DISQUE (critique pour Yocto)
    - name: Free Disk Space (Ubuntu)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true
      
    - name: Check available disk space
      run: |
        echo "=== Disk space after cleanup ==="
        df -h
        echo "=== Available space in GB ==="
        df -BG / | awk 'NR==2 {print $4}'

    - name: Cache downloads
      uses: actions/cache@v4
      with:
        path: build-sl1640/downloads
        key: yocto-sl1640-scarthgap-v2.1-dl-${{ hashFiles('kas-sl1640.yml') }}
        restore-keys: yocto-sl1640-scarthgap-v2.1-dl-

    - name: Cache sstate
      uses: actions/cache@v4
      with:
        path: build-sl1640/sstate-cache
        key: yocto-sl1640-scarthgap-v2.1-sstate-${{ hashFiles('kas-sl1640.yml') }}-${{ github.run_number }}
        restore-keys: |
          yocto-sl1640-scarthgap-v2.1-sstate-${{ hashFiles('kas-sl1640.yml') }}-
          yocto-sl1640-scarthgap-v2.1-sstate-

    - name: Download kas-container
      run: |
        wget -O kas-container https://raw.githubusercontent.com/siemens/kas/master/kas-container
        chmod +x kas-container

    - name: Build SL1640 Scarthgap v2.1.0
      run: |
        export KAS_BUILD_DIR=$(pwd)/build-sl1640
        rm -rf $(pwd)/build-sl1640
        ./kas-container build kas-sl1640.yml
    # VÉRIFICATION ESPACE DISQUE PENDANT LE BUILD
    - name: Monitor disk space during build
      if: always()
      run: |
        echo "=== Disk usage after build ==="
        df -h
        du -sh build-* 2>/dev/null || true
      
    - name: Show last 200 lines on failure
      if: failure()
      run: |
        echo "=== DERNIÈRES 200 LIGNES DU LOG ==="
        tail -200 build-sl1640/tmp/log/cooker/*/console-latest.log || true

    - name: Upload build log on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: sl1640-scarthgap-build-log-${{ github.sha }}
        path: |
          build-sl1640/tmp/log/
        retention-days: 7

    - name: Show build stats
      if: success()
      run: |
        echo "Build size:"
        du -sh build-sl1640/ || true
        echo "Images générées:"
        find build-sl1640/tmp/deploy/images/sl1640spi/ -type f -name "*.wic*" -o -name "Image*" || true
        df -h

    - name: Upload artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: sl1640spi-scarthgap-v2.1.0-${{ github.sha }}
        path: |
          build-sl1640/tmp/deploy/images/sl1640spi/*.wic.bz2
          build-sl1640/tmp/deploy/images/sl1640spi/*.tar.bz2
          build-sl1640/tmp/deploy/images/sl1640spi/Image*
          build-sl1640/tmp/deploy/images/sl1640spi/*.dtb
        retention-days: 7