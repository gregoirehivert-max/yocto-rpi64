name: Yocto Synaptics SL1640 Kernel Build

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'kas-sl1640.yml'
      - '.github/workflows/yocto-synaptics-sl1640.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-sl1640:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Free disk space
      run: |
        echo "Espace avant nettoyage:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/.ghcup
        sudo apt-get clean
        sudo docker image prune --all --force
        echo "Espace après nettoyage:"
        df -h

    - name: Cache Yocto downloads
      uses: actions/cache@v4
      with:
        path: build-sl1640/downloads
        key: yocto-sl1640-dl-${{ hashFiles('kas-sl1640.yml') }}
        restore-keys: |
          yocto-sl1640-dl-

    - name: Cache Yocto sstate
      uses: actions/cache@v4
      with:
        path: build-sl1640/sstate-cache
        key: yocto-sl1640-sstate-${{ hashFiles('kas-sl1640.yml') }}-${{ github.run_number }}
        restore-keys: |
          yocto-sl1640-sstate-${{ hashFiles('kas-sl1640.yml') }}-
          yocto-sl1640-sstate-

    - name: Download kas-container
      run: |
        wget -O kas-container https://raw.githubusercontent.com/siemens/kas/master/kas-container
        chmod +x kas-container

    - name: Build SL1640 kernel with kas-container
      run: |
        export KAS_BUILD_DIR=$(pwd)/build-sl1640
        ./kas-container build kas-sl1640.yml

    - name: Show build size
      run: |
        echo "Taille du répertoire build:"
        du -sh build-sl1640/ || true
        echo "Espace disque restant:"
        df -h

    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl1640-kernel-${{ github.sha }}
        path: |
          build-sl1640/tmp/deploy/images/sl1640/Image*
          build-sl1640/tmp/deploy/images/sl1640/*.dtb
          build-sl1640/tmp/deploy/images/sl1640/*.wic.bz2
        retention-days: 7
        compression-level: 9

    - name: Upload SDK (optional)
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: sl1640-sdk-${{ github.sha }}
        path: build-sl1640/tmp/deploy/sdk/*.sh
        retention-days: 14