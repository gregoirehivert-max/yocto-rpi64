
name: Build Yocto RPi 64-bit (Ubuntu 22.04)

on:
  workflow_dispatch:
    inputs:
      machine:
        description: "MACHINE Yocto (ex: raspberrypi4-64, raspberrypi3-64)"
        default: "raspberrypi4-64"
        required: true
      image:
        description: "Image à builder (ex: core-image-minimal, core-image-base, custom)"
        default: "core-image-minimal"
        required: true
      yocto_branch:
        description: "Branche Yocto (ex: scarthgap)"
        default: "scarthgap"
        required: true
      image_fstypes:
        description: "Type(s) d'image (ex: rpi-sdimg | wic wic.bmap)"
        default: "rpi-sdimg"
        required: true
  push:
    branches: [ main ]
  pull_request:

env:
  YOCTO_BRANCH: ${{ inputs.yocto_branch || 'scarthgap' }}
  MACHINE: ${{ inputs.machine || 'raspberrypi4-64' }}
  IMAGE: ${{ inputs.image || 'core-image-minimal' }}
  IMAGE_FSTYPES: ${{ inputs.image_fstypes || 'rpi-sdimg' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Préparer arborescence & caches
        run: |
          set -euo pipefail
          mkdir -p sources build downloads sstate-cache artifacts

      - name: Cache downloads (DL_DIR)
        uses: actions/cache@v4
        with:
          path: downloads
          key: yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-downloads-${{ runner.os }}
          restore-keys: |
            yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-downloads-
            yocto-${{ env.YOCTO_BRANCH }}-downloads-
            yocto-downloads-

      - name: Cache sstate (SSTATE_DIR)
        uses: actions/cache@v4
        with:
          path: sstate-cache
          key: yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-sstate-${{ runner.os }}
          restore-keys: |
            yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-sstate-
            yocto-${{ env.YOCTO_BRANCH }}-sstate-
            yocto-sstate-

      - name: Récupérer les couches Yocto
        run: |
          set -euo pipefail
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.yoctoproject.org/poky sources/poky
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.yoctoproject.org/meta-raspberrypi sources/meta-raspberrypi
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.openembedded.org/meta-openembedded sources/meta-openembedded

      - name: Build dans conteneur Ubuntu 22.04
        uses: addnab/docker-run-action@v3
        with:
          image: ubuntu:22.04
          options: >
            -v ${{ github.workspace }}:/work
            -e YOCTO_BRANCH=${{ env.YOCTO_BRANCH }}
            -e MACHINE=${{ env.MACHINE }}
            -e IMAGE=${{ env.IMAGE }}
            -e IMAGE_FSTYPES=${{ env.IMAGE_FSTYPES }}
          run: |
            #! /bin/bash
            set -eo pipefail
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y \
              git gawk wget diffstat unzip texinfo gcc build-essential chrpath socat cpio python3 python3-distutils python3-venv \
              zstd xz-utils tar pkg-config

            cd /work

            # Installer les buildtools officiels (assure toolchain cohérente)
            mkdir -p /work/.buildtools
            bash sources/poky/scripts/install-buildtools -n -t /work/.buildtools

            # Mettre buildtools EN TÊTE du PATH avant toute commande Yocto
            export PATH="/work/.buildtools/usr/bin:$PATH"
            export LD_LIBRARY_PATH="/work/.buildtools/usr/lib:/work/.buildtools/lib:${LD_LIBRARY_PATH:-}"
            export PYTHONNOUSERSITE=1

            echo "which python3 => $(which python3)"
            python3 --version

            # Initialiser l'environnement Yocto
            set +u
            export BBSERVER=""
            source /work/sources/poky/oe-init-build-env /work/build
            set -u

            # Ajouter les couches
            bitbake-layers add-layer /work/sources/meta-raspberrypi
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-oe
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-networking
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-python

            # Configurer local.conf (caches, machine, image types, parallélisme)
            cat <<'EOF' >> conf/local.conf
            MACHINE ??= "${MACHINE}"
            IMAGE_FSTYPES += " ${IMAGE_FSTYPES}"

            DL_DIR ?= "/work/downloads"
            SSTATE_DIR ?= "/work/sstate-cache"

            DISTRO_FEATURES:append = " systemd"

            BB_NUMBER_THREADS ?= "${@oe.utils.cpu_count()}"
            PARALLEL_MAKE ?= "-j${@oe.utils.cpu_count()}"

            # INHERIT += "rm_work"
            EOF

            # Sanity check: python résolu dans PATH à ce stade ?
            echo "python3 used by bitbake: $(which python3)"
            python3 --version

            # Build
            bitbake ${IMAGE}

            # Artefacts
            OUT=/work/artifacts
            mkdir -p "$OUT"
            DEPLOY="tmp/deploy/images/${MACHINE}"
            cp -v ${DEPLOY}/* ${OUT}/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
                   name: yocto-${{ env.MACHINE }}-${{ env.IMAGE }}-${{ env.YOCTO_BRANCH }}
          path: artifacts
