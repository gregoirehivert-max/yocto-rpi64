name: Yocto Build for Raspberry Pi 4 (64-bit)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y gawk wget git-core diffstat unzip texinfo gcc build-essential chrpath socat cpio python3 python3-pip python3-pexpect xz-utils debianutils iputils-ping bzip2

    - name: Clone Yocto layers
      run: |
        git clone -b kirkstone git://git.yoctoproject.org/poky
        cd poky
        git clone -b kirkstone git://git.yoctoproject.org/meta-raspberrypi
        git clone -b kirkstone git://git.openembedded.org/meta-openembedded
        cd ..

    - name: Configure Yocto for Raspberry Pi 4 (64-bit)
      run: |
        source poky/oe-init-build-env build
        echo 'MACHINE = "raspberrypi4-64"' >> conf/local.conf
        echo 'DISTRO = "poky"' >> conf/local.conf
        echo 'PACKAGE_CLASSES = "package_deb"' >> conf/local.conf
        echo 'EXTRA_IMAGE_FEATURES = "debug-tweaks"' >> conf/local.conf
        echo 'GPU_MEM = "256"' >> conf/local.conf
        echo 'ENABLE_UART = "1"' >> conf/local.conf
        echo 'IMAGE_FSTYPES = "rpi-sdimg"' >> conf/local.conf
        echo 'IMAGE_INSTALL_append = " vim python3 nano wayland weston"' >> conf/local.conf

    - name: Build Yocto image
      run: |
        source poky/oe-init-build-env build
        bitbake core-image-minimal

    - name: Upload Yocto Image
      uses: actions/upload-artifact@v4
      with:
        name: yocto-image
        path: poky/build/tmp/deploy/images/raspberrypi4-64/
