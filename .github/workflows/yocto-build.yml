
name: Build Yocto RPi 64-bit

on:
  workflow_dispatch:
    inputs:
      machine:
        description: "MACHINE Yocto (ex: raspberrypi4-64, raspberrypi3-64)"
        default: "raspberrypi4-64"
        required: true
      image:
        description: "Image à builder (ex: core-image-minimal, core-image-base)"
        default: "core-image-minimal"
        required: true
      yocto_branch:
        description: "Branche Yocto (ex: scarthgap)"
        default: "scarthgap"
        required: true
  push:
    branches: [ main ]
  pull_request:

env:
  YOCTO_BRANCH: ${{ inputs.yocto_branch || 'scarthgap' }}
  MACHINE: ${{ inputs.machine || 'raspberrypi4-64' }}
  IMAGE: ${{ inputs.image || 'core-image-minimal' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Préparer caches (downloads & sstate)
        run: |
          set -eux
          mkdir -p build/downloads build/sstate-cache

      - name: Cache downloads
        uses: actions/cache@v4
        with:
          path: build/downloads
          key: yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-downloads-${{ runner.os }}
          restore-keys: |
            yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-downloads-
            yocto-${{ env.YOCTO_BRANCH }}-downloads-
            yocto-downloads-

      - name: Cache sstate
        uses: actions/cache@v4
        with:
          path: build/sstate-cache
          key: yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-sstate-${{ runner.os }}
          restore-keys: |
            yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-sstate-
            yocto-${{ env.YOCTO_BRANCH }}-sstate-
            yocto-sstate-

      - name: Récupérer les couches Yocto
        run: |
          set -eux
          mkdir -p sources
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.yoctoproject.org/poky sources/poky
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.yoctoproject.org/meta-raspberrypi sources/meta-raspberrypi
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.openembedded.org/meta-openembedded sources/meta-openembedded

      - name: Build dans conteneur CROPS/Poky
        uses: addnab/docker-run-action@v3
        with:
          image: ghcr.io/crops/poky:latest
          options: >
            -v ${{ github.workspace }}:/work
            -e YOCTO_BRANCH=${{ env.YOCTO_BRANCH }}
            -e MACHINE=${{ env.MACHINE }}
            -e IMAGE=${{ env.IMAGE }}
          run: |
            set -eux
            cd /work

            # Éviter l'erreur "unbound variable" en désactivant nounset avant le source
            set +u
            # (Optionnel) éviter le mode serveur BitBake si variable non définie
            export BBSERVER=""
            # Initialiser l'environnement Yocto dans /work/build
            source sources/poky/oe-init-build-env build
            # Réactiver nounset après initialisation si souhaité
            set -u

            # Ajouter les couches nécessaires
            bitbake-layers add-layer /work/sources/meta-raspberrypi
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-oe
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-networking
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-python

            # Configurer local.conf pour RPi 64 bits et image SD
            cat <<'EOF' >> conf/local.conf
            MACHINE ??= "${MACHINE}"
            # Générer une image SD
            IMAGE_FSTYPES += " rpi-sdimg"
            # Optionnel: forcer systemd
            DISTRO_FEATURES:append = " systemd"
            # Accélérer la compilation en CI
            BB_NUMBER_THREADS ?= "${@oe.utils.cpu_count()}"
            PARALLEL_MAKE ?= "-j${@oe.utils.cpu_count()}"
            # (Optionnel) réduire la taille: décommentez pour supprimer les workdirs
            # INHERIT += "rm_work"
            EOF

            # Lancer la compilation
            bitbake ${IMAGE}

            # Collecter les artefacts
            OUT=/work/artifacts
            mkdir -p "$OUT"
            DEPLOY="tmp/deploy/images/${MACHINE}"
            cp -v ${DEPLOY}/* ${OUT}/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yocto-${{ env.MACHINE }}-${{ env.IMAGE }}-${{ env.YOCTO_BRANCH }}
          path          path: artifacts
