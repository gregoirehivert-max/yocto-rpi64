
name: Build Yocto RPi 64-bit

on:
  workflow_dispatch:
    inputs:
      machine:
        description: "MACHINE Yocto (ex: raspberrypi4-64, raspberrypi3-64)"
        default: "raspberrypi4-64"
        required: true
      image:
        description: "Image à builder (ex: core-image-minimal, core-image-base, custom)"
        default: "core-image-minimal"
        required: true
      yocto_branch:
        description: "Branche Yocto (ex: scarthgap)"
        default: "scarthgap"
        required: true
      image_fstypes:
        description: "Type(s) d'image (ex: rpi-sdimg | wic wic.bmap)"
        default: "rpi-sdimg"
        required: true
  push:
    branches: [ main ]
  pull_request:

env:
  YOCTO_BRANCH: ${{ inputs.yocto_branch || 'scarthgap' }}
  MACHINE: ${{ inputs.machine || 'raspberrypi4-64' }}
  IMAGE: ${{ inputs.image || 'core-image-minimal' }}
  IMAGE_FSTYPES: ${{ inputs.image_fstypes || 'rpi-sdimg' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Préparer arborescence & caches
        run: |
          set -euo pipefail
          mkdir -p sources build downloads sstate-cache artifacts

      - name: Cache downloads (DL_DIR)
        uses: actions/cache@v4
        with:
          path: downloads
          key: yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-downloads-${{ runner.os }}
          restore-keys: |
            yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-downloads-
            yocto-${{ env.YOCTO_BRANCH }}-downloads-
            yocto-downloads-

      - name: Cache sstate (SSTATE_DIR)
        uses: actions/cache@v4
        with:
          path: sstate-cache
          key: yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-sstate-${{ runner.os }}
          restore-keys: |
            yocto-${{ env.YOCTO_BRANCH }}-${{ env.MACHINE }}-sstate-
            yocto-${{ env.YOCTO_BRANCH }}-sstate-
            yocto-sstate-

      - name: Récupérer les couches Yocto
        run: |
          set -euo pipefail
          # poky + meta-raspberrypi + meta-openembedded (branches alignées)
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.yoctoproject.org/poky sources/poky
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.yoctoproject.org/meta-raspberrypi sources/meta-raspberrypi
          git clone --depth 1 -b "${YOCTO_BRANCH}" https://git.openembedded.org/meta-openembedded sources/meta-openembedded

      - name: Build dans conteneur CROPS/Poky (Docker Hub)
        uses: addnab/docker-run-action@v3
        with:
          image: crops/poky:latest
          options: >
            -v ${{ github.workspace }}:/work
            -e YOCTO_BRANCH=${{ env.YOCTO_BRANCH }}
            -e MACHINE=${{ env.MACHINE }}
            -e IMAGE=${{ env.IMAGE }}
            -e IMAGE_FSTYPES=${{ env.IMAGE_FSTYPES }}
          run: |
            #! /bin/bash
            set -eo pipefail
            cd /work

            # Éviter l'erreur "BBSERVER: unbound variable" pendant le sourcing
            set +u
            export BBSERVER=""
            # Initialiser l'environnement Yocto dans /work/build
            source sources/poky/oe-init-build-env build
            set -u

            # Installer les buildtools officiels (assure python3 >= 3.8)
            mkdir -p /work/.buildtools
            scripts/install-buildtools -n -t /work/.buildtools

            # Activer buildtools
            export PATH="/work/.buildtools/usr/bin:$PATH"
            export LD_LIBRARY_PATH="/work/.buildtools/usr/lib:/work/.buildtools/lib:${LD_LIBRARY_PATH:-}"

            # Vérification Python (BitBake requiert ≥ 3.8)
            python3 --version
            python3 - <<'PYCHK'
            import sys
            assert (sys.version_info.major, sys.version_info.minor) >= (3,8), f"Python {sys.version} < 3.8"
            print("Python OK pour BitBake:", sys.version)
            PYCHK

            # Ajouter les couches nécessaires
            bitbake-layers add-layer /work/sources/meta-raspberrypi
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-oe
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-networking
            bitbake-layers add-layer /work/sources/meta-openembedded/meta-python

            # Configurer local.conf : machine, types d'images, caches, parallélisme
            cat <<'EOF' >> conf/local.conf
            # Machine et types d'images
            MACHINE ??= "${MACHINE}"
            IMAGE_FSTYPES += " ${IMAGE_FSTYPES}"

            # Caches (montés en dehors de tmp pour persistance CI)
            DL_DIR ?= "/work/downloads"
            SSTATE_DIR ?= "/work/sstate-cache"

            # Optionnel: système d'init
            DISTRO_FEATURES:append = " systemd"

            # Parallélisme CI
            BB_NUMBER_THREADS ?= "${@oe.utils.cpu_count()}"
            PARALLEL_MAKE ?= "-j${@oe.utils.cpu_count()}"

            # (Optionnel) réduire la taille en CI
            # INHERIT += "rm_work"
            EOF

            # Build de l'image
            bitbake ${IMAGE}

            # Collecte des artefacts
            OUT=/work/artifacts
            mkdir -p "$OUT"
            DEPLOY="tmp/deploy/images/${MACHINE}"
            # Images (sdimg/wic), kernel, dtbs, bootloaders, manifs
            cp -v ${DEPLOY}/* ${OUT}/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yocto-${{ env.MACHINE }}-${{ env.IMAGE }}-${{ env.YOCTO_BRANCH }}
          path: artifacts
         
